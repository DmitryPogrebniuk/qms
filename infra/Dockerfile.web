# Build stage
FROM node:20-slim AS builder

WORKDIR /app

# Install ca-certificates for npm
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*

COPY package.json tsconfig.json ./
COPY packages ./packages
COPY apps/web ./apps/web

RUN npm install --legacy-peer-deps --no-fund
RUN npm run build -w packages/shared
RUN npm run build -w apps/web

# Runtime stage
FROM node:18-slim

WORKDIR /app

# Install ca-certificates and http-server
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*
RUN npm install -g http-server

COPY --from=builder /app/apps/web/dist ./dist

EXPOSE 5173

CMD ["http-server", "dist", "-p", "5173", "--gzip", "-c-1"]
