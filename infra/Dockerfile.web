# Build stage
FROM node:20-slim AS builder

WORKDIR /app

# Install ca-certificates for npm
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*

COPY package.json tsconfig.json ./
COPY packages ./packages
COPY apps/web ./apps/web

RUN npm install --legacy-peer-deps --no-fund
RUN npm run build -w packages/shared
RUN npm run build -w apps/web

# Runtime stage - use nginx for proper API proxying
FROM nginx:alpine

# Copy built files
COPY --from=builder /app/apps/web/dist /usr/share/nginx/html

# Copy nginx config
COPY infra/nginx/web.conf /etc/nginx/conf.d/default.conf

EXPOSE 5173

CMD ["nginx", "-g", "daemon off;"]
