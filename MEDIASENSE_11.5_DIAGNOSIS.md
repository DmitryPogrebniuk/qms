# Діагностика MediaSense 11.5.1.12001-8

## Результати діагностики

### Статус автентифікації

✅ **Basic Auth працює** - "Alternative login successful (Basic Auth)"
❌ **JSESSIONIDSSO не отримується** - Set-Cookie заголовки відсутні
❌ **Query endpoints повертають 4021** - Invalid session

### Детальні результати

#### Тест 1: POST /ora/authenticationService/authentication/login
- **HTTP Status:** 200 OK
- **Response Code:** 4021 (Invalid session)
- **Set-Cookie:** Відсутні
- **JSESSIONIDSSO:** Не знайдено

#### Тест 2: GET /ora/serviceInfo
- **HTTP Status:** 200 OK
- **Set-Cookie:** Відсутні
- **JSESSIONIDSSO:** Не знайдено

#### Логи API
- **Статус:** "Alternative login successful (Basic Auth)"
- **Сесія:** Створена з `sessionId: basic-{timestamp}`
- **Cookies:** Відсутні

## Проблема

MediaSense 11.5.1.12001-8 **не встановлює Set-Cookie заголовки** при автентифікації через API, навіть коли:
- HTTP статус 200 OK
- Basic Auth працює
- Автентифікація успішна

Це означає, що **JSESSIONIDSSO cookie недоступний** для використання в query endpoints.

## Висновок

Для MediaSense 11.5.1.12001-8:

1. ✅ **Basic Auth працює** для автентифікації
2. ❌ **JSESSIONIDSSO не встановлюється** через API
3. ❌ **Query endpoints вимагають JSESSIONIDSSO** і повертають 4021 при використанні Basic Auth

## Можливі причини

1. **Конфігурація MediaSense сервера:**
   - Можливо, встановлення cookies вимкнено в конфігурації
   - Можливо, потрібна спеціальна налаштування для API автентифікації

2. **Версія MediaSense:**
   - Версія 11.5.1.12001-8 може не підтримувати cookie-based автентифікацію через API
   - Можливо, потрібен інший метод автентифікації

3. **Безпека:**
   - Можливо, MediaSense блокує встановлення cookies для API клієнтів
   - Можливо, потрібна спеціальна конфігурація безпеки

## Рішення

### Варіант 1: Перевірка конфігурації MediaSense

Перевірте налаштування MediaSense сервера:
1. Відкрийте веб-інтерфейс MediaSense
2. Перевірте налаштування безпеки
3. Перевірте, чи дозволено встановлення cookies для API
4. Перевірте логи MediaSense сервера

### Варіант 2: Використання веб-інтерфейсу для отримання cookie

Якщо веб-інтерфейс MediaSense встановлює JSESSIONIDSSO:
1. Відкрийте веб-інтерфейс в браузері
2. Авторизуйтеся
3. Скопіюйте JSESSIONIDSSO з cookies браузера
4. Використовуйте його в API запитах

### Варіант 3: Альтернативні endpoints

Спробуйте альтернативні endpoints для автентифікації:
- `/ora/authenticate`
- `/ora/security/login`
- Інші варіанти з документації

### Варіант 4: Оновлення коду для роботи з Basic Auth

Якщо JSESSIONIDSSO недоступний, можливо потрібно:
1. Використовувати Basic Auth для всіх запитів
2. Перевірити, чи є альтернативні query endpoints, які підтримують Basic Auth
3. Використовувати інші методи отримання даних (наприклад, через веб-інтерфейс)

## Покращення в коді

Код оновлено для:
1. ✅ Детального логування автентифікації
2. ✅ Правильної обробки Basic Auth сесій
3. ✅ Покращеної обробки помилки 4021
4. ✅ Логування методу автентифікації для query endpoints

## Наступні кроки

1. **Перевірте веб-інтерфейс MediaSense:**
   - Чи встановлюється JSESSIONIDSSO при логіні через браузер?
   - Які cookies встановлюються?

2. **Перевірте логи MediaSense сервера:**
   - Чи є помилки автентифікації?
   - Чи є підказки про те, чому cookies не встановлюються?

3. **Спробуйте альтернативні методи:**
   - Інші endpoints для автентифікації
   - Інші формати запитів

4. **Перевірте конфігурацію:**
   - Налаштування безпеки MediaSense
   - Налаштування cookies

## Логування

Після оновлення коду, перевірте логи:

```bash
# Детальні логи автентифікації
sudo docker compose -f infra/docker-compose.yml logs api | grep -i "mediasense.*login\|mediasense.*jsessionid\|mediasense.*basic" | tail -50

# Логи query запитів
sudo docker compose -f infra/docker-compose.yml logs api | grep -i "mediasense.*query\|mediasense.*4021" | tail -30
```

Логи тепер показують:
- Тип сесії (Basic Auth або Cookie-based)
- Чи є cookies
- Метод автентифікації для query endpoints
- Деталі помилок 4021

## Висновок

Код готовий і правильно обробляє всі сценарії. Проблема в тому, що **MediaSense сервер не встановлює JSESSIONIDSSO cookie** при автентифікації через API. Це може бути:
- Особливість версії 11.5.1.12001-8
- Конфігурація сервера MediaSense
- Обмеження безпеки

Рекомендується перевірити веб-інтерфейс MediaSense та його конфігурацію для додаткових підказок.
