# Перевірка правильності звернення до MediaSense API

## Проблема

Потрібно перевірити, чи правильно ми звертаємось до API MediaSense, оскільки синхронізація повертає `totalFetched: 0` записів.

## Що перевірити

### 1. Запустіть тестовий скрипт

```bash
cd /opt/qms
sudo git pull origin main
sudo chmod +x test-mediasense-api.sh
sudo ./test-mediasense-api.sh
```

Цей скрипт:
- Перевіряє автентифікацію
- Тестує різні формати запитів (POST з conditions, GET з query params)
- Показує реальну структуру відповіді від MediaSense
- Допомагає визначити правильний формат запиту

### 2. Перевірте логи API після покращень

Після оновлення коду, логи тепер показують структуру відповіді:

```bash
sudo docker compose -f infra/docker-compose.yml logs api | grep -i "mediasense.*response\|mediasense.*structure" | tail -50
```

### 3. Можливі проблеми та рішення

#### Проблема 1: Неправильний формат запиту

**Симптоми:**
- HTTP 200, але порожня відповідь
- `totalFetched: 0`

**Рішення:**
MediaSense може очікувати інший формат. Перевірте в тестовому скрипті, який формат працює:
- POST з `conditions` (поточний формат)
- POST тільки з `sessionEndTime` (альтернативний)
- GET з query параметрами

#### Проблема 2: Неправильна структура відповіді

**Симптоми:**
- Дані є, але не парсяться
- `normalizeSessionData` повертає порожній масив

**Рішення:**
Після покращень код підтримує різні формати:
- `rawData.sessions`
- `rawData.recordings`
- `rawData.results`
- `rawData.data.sessions`
- `rawData.items`
- Прямий масив

Логи покажуть, яка структура прийшла.

#### Проблема 3: Неправильні назви полів

**Симптоми:**
- Сесії знаходяться, але поля порожні
- `sessionId` не знаходиться

**Рішення:**
Перевірте в логах `rawJson` - там зберігається оригінальна відповідь. Можливо, потрібно оновити маппінг полів в `normalizeSessionData`.

## Поточний формат запиту

```json
POST /ora/queryService/query/sessions
{
  "queryType": "sessions",
  "conditions": [
    {
      "field": "sessionStartTime",
      "operator": "gte",
      "value": "2026-01-18T19:00:00.000Z"
    },
    {
      "field": "sessionEndTime",
      "operator": "lte",
      "value": "2026-01-25T19:00:00.000Z"
    }
  ],
  "sorting": [
    { "field": "sessionEndTime", "order": "asc" }
  ],
  "paging": {
    "offset": 0,
    "limit": 100
  }
}
```

## Альтернативні формати

### Варіант 1: Тільки sessionEndTime
```json
{
  "queryType": "sessions",
  "conditions": [
    {
      "field": "sessionEndTime",
      "operator": "gte",
      "value": "2026-01-18T19:00:00.000Z"
    },
    {
      "field": "sessionEndTime",
      "operator": "lte",
      "value": "2026-01-25T19:00:00.000Z"
    }
  ],
  "paging": { "offset": 0, "limit": 100 }
}
```

### Варіант 2: GET з query параметрами
```
GET /ora/queryService/query/sessions?startTime=2026-01-18T19:00:00.000Z&endTime=2026-01-25T19:00:00.000Z&maxResults=100&offset=0
```

## Наступні кроки

1. **Запустіть тестовий скрипт** і подивіться, який формат працює
2. **Перевірте логи** після оновлення коду - вони покажуть структуру відповіді
3. **Якщо потрібно**, оновіть формат запиту в `media-sense-client.service.ts` на основі результатів тесту
4. **Перевірте маппінг полів** в `normalizeSessionData` - можливо, потрібно додати інші назви полів

## Діагностика

Після запуску тестового скрипта та перевірки логів, ви зможете:

1. **Визначити правильний формат запиту** - який HTTP метод та структура body працює
2. **Зрозуміти структуру відповіді** - де знаходяться дані (sessions, recordings, results, тощо)
3. **Виправити маппінг полів** - якщо назви полів відрізняються від очікуваних

## Приклад виводу тестового скрипта

```
[INFO] 1. Тест автентифікації...
✓ Автентифікація успішна (HTTP 200)

[INFO] 2. Тест запиту сесій (POST з conditions)...
  HTTP Status: 200
✓ Запит успішний
  Відповідь:
  {
    "sessions": [
      {
        "sessionId": "12345",
        "startTime": "2026-01-18T19:00:00.000Z",
        ...
      }
    ]
  }
  Знайдено сесій: 5
```

Якщо ви бачите структуру відповіді, ви зможете оновити код для правильного парсингу.
